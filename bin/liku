#!/usr/bin/env bash

set -euo pipefail

CORE_DIR="${HOME}/.liku/core"
BOOKKEEPER_DIR="${HOME}/.liku/bookkeeper"
STATE_AGENT_DIR="${HOME}/.liku/state/agents"

usage() {
    cat <<'USAGE'
Usage:
  liku spawn <agent-name>
  liku bookkeeper
  liku status
  liku event stream
    liku exec [--window <name>] [--cwd <path>] [--label <text>] -- <command>
    liku panes

Environment:
  Files are managed under ~/.liku. Ensure ./install.sh has been run.
USAGE
}

liku_status() {
    if [ ! -d "$STATE_AGENT_DIR" ] || ! compgen -G "${STATE_AGENT_DIR}/*.json" >/dev/null; then
        printf "[Liku] No agents have been spawned yet.\n"
        return
    fi

    printf 'AGENT\tPID\tSESSION\n'
    for file in "${STATE_AGENT_DIR}"/*.json; do
        [ -e "$file" ] || continue
        local agent pid session
        agent=$(basename "$file" .json)
        pid=$(awk -F'"' '/"pid"/ {print $4}' "$file")
        session=$(awk -F'"' '/"session"/ {print $4}' "$file")
        printf '%s\t%s\t%s\n' "$agent" "${pid:-?}" "${session:-?}"
    done
}

cmd="${1:-}"
if [ -z "$cmd" ]; then
    usage
    exit 1
fi
shift || true

case "$cmd" in
    spawn)
        bash "${CORE_DIR}/subagent-engine.sh" spawn "$@"
        ;;
    bookkeeper)
        bash "${BOOKKEEPER_DIR}/ui.sh"
        ;;
    status)
        liku_status
        ;;
    event)
        subcmd="${1:-}"
        shift || true
        case "$subcmd" in
            stream)
                bash "${CORE_DIR}/event-bus.sh" stream "$@"
                ;;
            *)
                printf '[Liku] Unknown event subcommand. Try "liku event stream".\n' >&2
                exit 1
                ;;
        esac
        ;;
    exec)
        bash "${CORE_DIR}/tmux-agent.sh" exec "$@"
        ;;
    panes)
        bash "${CORE_DIR}/tmux-agent.sh" list "$@"
        ;;
    *)
        usage
        exit 1
        ;;
esac
